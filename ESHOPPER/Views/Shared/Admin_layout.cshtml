<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
      /* Thêm một chút style để sidebar cuộn được trên màn hình nhỏ nếu nội dung quá dài */
      @@media (min-width: 768px) {
        .sidebar {
          position: sticky;
          top: 0;
          height: 100vh;
          overflow-y: auto;
        }
      }
      .nav-link {
        color: #333;
      }
      .nav-link.active,
      .nav-link:hover {
        color: #0d6efd;
      }
      /* Style cho submenu collapse */
      .sidebar .nav-link[data-bs-toggle="collapse"]::after {
        content: "\f067"; /* Font Awesome plus icon */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        float: right;
        transition: transform 0.2s;
      }
      .sidebar
        .nav-link[data-bs-toggle="collapse"][aria-expanded="true"]::after {
        content: "\f068"; /* Font Awesome minus icon */
        transform: rotate(180deg);
      }
    </style>
</head>
<body style="background-color: #f8f9fa">
    <div class="container-fluid">
        <div class="row">
            <nav class="col-12 col-md-3 col-lg-2 bg-white p-3 min-vh-100 shadow-sm sidebar">
                <div class="text-center mb-3">
                    <a href="@Url.Action("dashboard","admin")" class="text-decoration-none text-dark">
                        <h4 class="m-0 fw-bold">
                            <span class="border me-2 px-2 py-1" style="color: #BC8F8F; border-radius: 4px;">
                                E
                            </span>Shopper
                        </h4>
                    </a>
                </div>
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("dashboard", "admin")">
                            <i class="fa-solid fa-gauge-high me-2"></i> Dashboard   
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link"
                           href="#order-submenu"
                           data-bs-toggle="collapse"
                           role="button"
                           aria-expanded="false"
                           aria-controls="order-submenu">
                            <i class="fa-solid fa-clipboard-list me-2"></i> Đơn hàng
                        </a>
                        <div class="collapse" id="order-submenu">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="#">
                                        <i class="fa-solid fa-caret-right me-2"></i> Danh sách
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link"
                           href="#product-submenu"
                           data-bs-toggle="collapse"
                           role="button"
                           aria-expanded="false"
                           aria-controls="product-submenu">
                            <i class="fa-solid fa-box me-2"></i> Sản phẩm
                        </a>
                        <div class="collapse" id="product-submenu">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Index", "SanPhams", new { area = "" })">
                                        <i class="fa-solid fa-caret-right me-2"></i> Danh sách
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Create", "SanPhams", new { area = "" })">
                                        <i class="fa-solid fa-caret-right me-2"></i> Thêm sản phẩm
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                           href="#account-submenu"
                           data-bs-toggle="collapse"
                           role="button"
                           aria-expanded="false"
                           aria-controls="account-submenu">
                            <i class="fa-solid fa-users-cog me-2"></i> Quản lý tài khoản
                        </a>
                        <div class="collapse" id="account-submenu">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Index", "Account", new { area = "" })">
                                        <i class="fa-solid fa-caret-right me-2"></i> Danh sách
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Create", "Account", new { area = "" })">
                                        <i class="fa-solid fa-caret-right me-2"></i> Thêm mới
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </nav>

            <main class="col-12 col-md-9 col-lg-10 p-4">
                <nav class="navbar navbar-expand-lg navbar-light bg-white rounded shadow-sm mb-4 p-3">
                    <div class="container-fluid">
                        <div class="navbar-nav d-none d-md-flex">
                            <a class="nav-link" href="#" id="fullscreen-toggle">
                                <i class="fa-solid fa-expand"></i>
                            </a>
                        </div>

                        <ul class="navbar-nav ms-auto flex-row align-items-center">
                            <li class="nav-item me-3">
                                <a class="nav-link" href="#">
                                    <i class="fa-solid fa-bell"></i>
                                </a>
                            </li>

                            <li class="nav-item me-3">
                                <a class="nav-link" href="#">
                                    <i class="fa-solid fa-message"></i>
                                </a>
                            </li>

                            <li class="nav-item dropdown" id="user-nav-dropdown">

                            </li>

                        </ul>
                    </div>
                </nav>

                @RenderBody()
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Lấy token (giả sử admin cũng dùng "jwtToken")
            const token = localStorage.getItem("jwtToken");

            // Lấy vị trí để chèn HTML
            const userDropdown = document.getElementById("user-nav-dropdown");

            // Giả sử đường dẫn đăng nhập của Admin
            const adminLoginUrl = "/Auth/Login"; // <-- Sửa lại nếu cần

            if (token) {
                // 1. NẾU CÓ TOKEN (Đã đăng nhập)
                try {
                    // Giải mã payload
                    const payload = JSON.parse(atob(token.split('.')[1]));

                    // Lấy Tên (ưu tiên UserName, name, email, hoặc "Admin")
                    const userName = payload.UserName || payload.name || payload.email || "Admin";

                    // Lấy ảnh (ưu tiên 'picture', 'avatar', hoặc ảnh mặc định)
                    const avatarUrl = payload.picture || payload.avatar || "/images/download.jpg"; // <-- Sửa ảnh mặc định nếu cần

                    // Chèn HTML vào <li>
                    userDropdown.innerHTML = `
                    <a class="nav-link dropdown-toggle"
                       href="#"
                       role="button"
                       data-bs-toggle="dropdown"
                       aria-expanded="false">
                        ${userName}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="/Admin/Profile">Hồ sơ</a> </li>
                        <li>
                            <a class="dropdown-item" href="/Admin/Settings">Cài đặt</a> </li>
                        <li><hr class="dropdown-divider" /></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" id="logoutBtn">Đăng xuất</a>
                        </li>
                    </ul>
                `;
                } catch (err) {
                    // Lỗi giải mã (token hỏng, hết hạn, v.v.)
                    console.error("JWT decode error:", err);
                    localStorage.removeItem("jwtToken");
                    window.location.href = adminLoginUrl; // Đưa về trang đăng nhập
                }
            } else {
                // 2. NẾU KHÔNG CÓ TOKEN (Chưa đăng nhập)
                // Đây là trang Admin, nên chuyển hướng về trang đăng nhập
                window.location.href = adminLoginUrl;

                // (Code dự phòng nếu bạn vẫn muốn hiển thị link Login)
                // userDropdown.innerHTML = `
                //     <a class="nav-link" href="${adminLoginUrl}">
                //         <i class="fa-solid fa-sign-in-alt me-2"></i> Đăng nhập
                //     </a>
                // `;
            }

            // Xử lý đăng xuất (giống hệt code của bạn)
            document.body.addEventListener("click", (e) => {
                // Kiểm tra nếu bấm vào link/button có id "logoutBtn"
                if (e.target.id === "logoutBtn") {
                    e.preventDefault(); // Ngăn link <a> nhảy trang
                    localStorage.removeItem("jwtToken");
                    window.location.href = adminLoginUrl; // Đưa về trang đăng nhập Admin
                }
            });
        });
    </script>
    <script>
        // Dữ liệu mẫu
        const revenueData = {
            labels: [
                "Tháng 1",
                "Tháng 2",
                "Tháng 3",
                "Tháng 4",
                "Tháng 5",
                "Tháng 6",
                "Tháng 7",
            ],
            datasets: [
                {
                    label: "Doanh thu (triệu VNĐ)",
                    data: [65, 59, 80, 81, 56, 55, 90],
                    fill: false,
                    borderColor: "rgb(75, 192, 192)",
                    tension: 0.1,
                },
            ],
        };

        const productData = {
            labels: ["Xe Đạp Đua", "Xe Đạp Địa Hình", "Xe Đạp Trẻ Em"],
            datasets: [
                {
                    label: "Tỷ lệ sản phẩm",
                    data: [300, 150, 100],
                    backgroundColor: [
                        "rgb(255, 99, 132)",
                        "rgb(54, 162, 235)",
                        "rgb(255, 205, 86)",
                    ],
                    hoverOffset: 4,
                },
            ],
        };

        // Vẽ biểu đồ
        document.addEventListener("DOMContentLoaded", () => {
            const ctxRevenue = document.getElementById("revenueChart");
            if (ctxRevenue) {
                new Chart(ctxRevenue, {
                    type: "line",
                    data: revenueData,
                });
            }

            const ctxProduct = document.getElementById("productPieChart");
            if (ctxProduct) {
                new Chart(ctxProduct, {
                    type: "doughnut",
                    data: productData,
                });
            }

            // Code cho Fullscreen
            const fullscreenButton = document.getElementById("fullscreen-toggle");
            if (fullscreenButton) {
                const fullscreenIcon = fullscreenButton.querySelector("i");

                fullscreenButton.addEventListener("click", (e) => {
                    e.preventDefault();

                    if (!document.fullscreenElement) {
                        document.documentElement
                            .requestFullscreen()
                            .then(() => {
                                fullscreenIcon.classList.remove("fa-expand");
                                fullscreenIcon.classList.add("fa-compress");
                            })
                            .catch((err) => {
                                console.error(
                                    `Error attempting to enable full-screen mode: ${err.message} (${err.name})`
                                );
                            });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen().then(() => {
                                fullscreenIcon.classList.remove("fa-compress");
                                fullscreenIcon.classList.add("fa-expand");
                            });
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
