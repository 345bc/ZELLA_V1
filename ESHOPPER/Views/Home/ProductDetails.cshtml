@model ESHOPPER.Models.ProductDetailsViewModel
@using Newtonsoft.Json

@{
    ViewBag.Title = "Chi tiết sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@* --- GIỮ NGUYÊN CSS --- *@
<style>
    /* ... (Giữ nguyên toàn bộ CSS cũ của bạn ở đây) ... */
    .product-detail-section { padding: 60px 0; background-color: #fcfcfc; }
    .product-gallery-wrapper { border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); background: #fff; }
    .main-img-container { position: relative; height: 500px; background-color: #fff; display: flex; align-items: center; justify-content: center; }
    .main-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease; }
    .main-img-container:hover img { transform: scale(1.05); }
    .product-info-wrapper { position: sticky; top: 100px; padding-left: 30px; }
    .product-title { font-size: 2rem; font-weight: 800; color: #333; margin-bottom: 10px; line-height: 1.2; }
    .product-price { font-size: 1.8rem; font-weight: 700; color: #D19C97; margin-bottom: 20px; display: inline-block; }
    .product-desc { font-size: 0.95rem; color: #666; line-height: 1.6; margin-bottom: 30px; }
    .variant-label { font-weight: 600; color: #333; margin-bottom: 10px; display: block; }
    .size-option { display: inline-block; margin-right: 10px; margin-bottom: 10px; }
    .size-option input { display: none; }
    .size-option label { display: block; min-width: 45px; height: 45px; line-height: 45px; text-align: center; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 8px; font-weight: 600; transition: all 0.2s; padding: 0 10px; }
    .size-option input:checked + label { background-color: #333; color: #fff; border-color: #333; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .color-option { display: inline-block; margin-right: 10px; margin-bottom: 10px; }
    .color-option input { display: none; }
    .color-option label { display: block; width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #eee; cursor: pointer; transition: all 0.2s; }
    .color-option input:checked + label { box-shadow: 0 0 0 2px #333; transform: scale(1.1); }
    .qty-box { display: flex; align-items: center; border: 2px solid #eee; border-radius: 30px; width: 140px; overflow: hidden; margin-right: 20px; }
    .qty-btn { width: 40px; height: 45px; background: transparent; border: none; font-size: 1.2rem; color: #333; cursor: pointer; transition: 0.2s; }
    .qty-btn:hover { background-color: #f8f9fa; }
    .qty-input { width: 60px; border: none; text-align: center; font-weight: 700; font-size: 1.1rem; background: transparent; }
    .qty-input:focus { outline: none; }
    .btn-add-cart { background-color: #333; color: #fff; border: none; padding: 12px 40px; border-radius: 30px; font-weight: 700; font-size: 1rem; letter-spacing: 1px; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-grow: 1; cursor: pointer; }
    .btn-add-cart:hover { background-color: #D19C97; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(209, 156, 151, 0.4); color: #fff; }
</style>

<div class="product-detail-section container-fluid px-5">
    <div class="container-fluid px-5">
        <div class="row">
            @* --- CỘT TRÁI: ẢNH --- *@
            <div class="col-lg-6 pb-5">
                <div class="product-gallery-wrapper">
                    <div class="main-img-container">
                        <img id="main-product-image"
                             src="@Url.Content("~/Images/Products/"+ Model.SanPhamChinh.AnhSP)"
                             alt="@Model.SanPhamChinh.TenSanPham">
                    </div>
                </div>
            </div>

            @* --- CỘT PHẢI: THÔNG TIN --- *@
            <div class="col-lg-6 pb-5">
                <div class="product-info-wrapper">
                    <h2 class="product-title">@Model.SanPhamChinh.TenSanPham</h2>

                    <div class="d-flex align-items-center mb-3">
                        <div class="text-primary mr-2">
                            <small class="fas fa-star"></small><small class="fas fa-star"></small><small class="fas fa-star"></small><small class="fas fa-star"></small><small class="fas fa-star"></small>
                        </div>
                        <small class="pt-1 text-muted">(50 Đánh giá)</small>
                    </div>

                    <h3 class="product-price" id="product-price">
                        @string.Format("{0:N0} ₫", Model.SanPhamChinh.GiaBanLe)
                    </h3>

                    <p class="product-desc">@Model.SanPhamChinh.MoTa</p>

                    @* QUAN TRỌNG: Thay đổi Html.BeginForm thành thẻ div wrapper hoặc form thường.
                       Chúng ta sẽ xử lý submit bằng JavaScript (AJAX) hoàn toàn.
                    *@
                    <form id="addToCartForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="productId" value="@Model.SanPhamChinh.MaSP" />

                        @* 1. CHỌN SIZE *@
                        <div class="mb-4">
                            <span class="variant-label">Chọn Size:</span>
                            <div class="d-flex flex-wrap">
                                @foreach (var size in Model.CacSizeDuyNhat)
                                {
                                    <div class="size-option">
                                        <input type="radio" id="size-@size" name="selectedSize" value="@size">
                                        <label for="size-@size">@size</label>
                                    </div>
                                }
                            </div>
                        </div>

                        @* 2. CHỌN MÀU *@
                        <div class="mb-4">
                            <span class="variant-label">Chọn Màu:</span>
                            <div class="d-flex flex-wrap">
                                @foreach (var color in Model.CacMauDuyNhat)
                                {
                                    string colorHex = "#ccc";
                                    string c = color.ToLower();
                                    if (c == "black") { colorHex = "#000"; }
                                    else if (c == "white") { colorHex = "#fff"; }
                                    else if (c == "red") { colorHex = "#ff0000"; }
                                    else if (c == "blue") { colorHex = "#0000ff"; }
                                    else if (c == "green") { colorHex = "#008000"; }
                                    else if (c == "yellow") { colorHex = "#ffff00"; }
                                    else if (c == "pink") { colorHex = "#ffc0cb"; }
                                    else if (c == "purple") { colorHex = "#800080"; }
                                    else if (c == "grey" || c == "gray") { colorHex = "#808080"; }

                                    <div class="color-option">
                                        <input type="radio" id="color-@color" name="selectedColor" value="@color">
                                        <label for="color-@color" style="background-color: @colorHex; @(c == "white" ? "border: 1px solid #ccc;" : "")" title="@color"></label>
                                    </div>
                                }
                            </div>
                        </div>

                        @* 3. SỐ LƯỢNG & NÚT MUA *@
                        <div class="d-flex align-items-center mb-4 pt-2">
                            <div class="qty-box quantity">
                                <button type="button" class="qty-btn btn-minus"><i class="fa fa-minus"></i></button>
                                <input type="text" id="quantity" class="qty-input" value="1" min="1">
                                <button type="button" class="qty-btn btn-plus"><i class="fa fa-plus"></i></button>
                            </div>

                            @* type="button" để tránh submit form mặc định *@
                            <button type="button" id="btnAddToCart" class="btn-add-cart">
                                <i class="fa fa-shopping-bag mr-2"></i> Thêm vào giỏ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        @* --- Phần Reviews (Giữ nguyên) --- *@
        <div class="row mt-5">
            <div class="col-12">
                <div class="bg-white p-5 rounded shadow-sm">
                    <h4 class="mb-4 font-weight-bold">Đánh giá (0)</h4>
                    <p class="text-muted">Chức năng này đang được cập nhật...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- SẢN PHẨM KHÁC (Giữ nguyên) --- *@
<div class="container-fluid pt-5 px-5">
    <div class="section-title-modern"><h2>Sản phẩm khác</h2></div>
    <div class="row px-xl-5 pb-3">
        @foreach (var item in Model.SanPhamNgauNhiens.Take(4))
        {
            <div class="col-lg-3 col-md-6 col-sm-12 pb-1">
                <div class="product-card-modern">
                    <div class="product-img-wrap">
                        <img src="@Url.Content("~/Images/Products/" + item.AnhSP)" alt="@item.TenSanPham">
                        <div class="product-actions">
                             <a href="@Url.Action("ProductDetails", "Home", new { id = item.MaSP })" class="btn-action"><i class="fas fa-eye"></i></a>
                        </div>
                    </div>
                    <div class="product-info">
                        <a href="@Url.Action("ProductDetails", "Home", new { id = item.MaSP })" class="text-decoration-none">
                            <h6 class="product-name">@item.TenSanPham</h6>
                        </a>
                        <div class="product-price">@String.Format("{0:N0} ₫", item.GiaBanLe)</div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    @* Thư viện SweetAlert2 *@
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- 1. XỬ LÝ BIẾN THỂ (ẢNH & GIÁ) ---
            const variants = @Html.Raw(JsonConvert.SerializeObject(
                Model.SanPhamChinh.BienTheSanPhams.Select(b => new {
                    b.MaSize, b.MaMau, b.GiaBan, b.AnhBienThe
                })
            ));
            const defaultPrice = @(Model.SanPhamChinh.GiaBanLe ?? 0);
            const defaultImage = '@Url.Content("~/Images/Products/" + (Model.SanPhamChinh.AnhSP ?? "no-image.jpg"))';

            function updateProductDetails() {
                const sizeInput = document.querySelector('input[name="selectedSize"]:checked');
                const colorInput = document.querySelector('input[name="selectedColor"]:checked');
                const size = sizeInput ? sizeInput.value : null;
                const color = colorInput ? colorInput.value : null;

                let price = defaultPrice;
                let image = defaultImage;

                if (size && color) {
                    const v = variants.find(x => x.MaSize == size && x.MaMau == color);
                    if (v) {
                        price = v.GiaBan || defaultPrice;
                        if (v.AnhBienThe && v.AnhBienThe.trim() !== '') {
                            image = '@Url.Content("~/Images/Products/")' + v.AnhBienThe;
                        }
                    }
                }
                
                const priceEl = document.getElementById('product-price');
                const imgEl = document.getElementById('main-product-image');
                if (priceEl) priceEl.textContent = price.toLocaleString('vi-VN') + ' ₫';
                if (imgEl) {
                    imgEl.onerror = () => imgEl.src = defaultImage;
                    imgEl.src = image;
                }
            }

            document.querySelectorAll('input[name="selectedSize"], input[name="selectedColor"]').forEach(el => {
                el.addEventListener('change', updateProductDetails);
            });

            // --- 2. XỬ LÝ TĂNG GIẢM SỐ LƯỢNG ---
            document.addEventListener('click', function (e) {
                if (e.target.closest('.btn-plus')) {
                    const input = document.getElementById('quantity');
                    input.value = parseInt(input.value || 0) + 1;
                }
                if (e.target.closest('.btn-minus')) {
                    const input = document.getElementById('quantity');
                    const val = parseInt(input.value || 0);
                    if (val > 1) input.value = val - 1;
                }
            });

            // --- 3. XỬ LÝ AJAX THÊM VÀO GIỎ HÀNG (QUAN TRỌNG NHẤT) ---
            const btnAddToCart = document.getElementById('btnAddToCart');
            
            btnAddToCart.addEventListener('click', function(e) {
                e.preventDefault(); // Ngăn hành vi mặc định (dù đã set type=button cho chắc)

                // 1. Lấy dữ liệu từ Form
                const pid = document.getElementById('productId').value;
                const qty = document.getElementById('quantity').value;
                const sizeInput = document.querySelector('input[name="selectedSize"]:checked');
                const colorInput = document.querySelector('input[name="selectedColor"]:checked');

                // 2. Validate phía Client
                if (!sizeInput || !colorInput) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn phân loại',
                        text: 'Vui lòng chọn Size và Màu sắc trước khi thêm vào giỏ!',
                        confirmButtonColor: '#333'
                    });
                    return;
                }

                const size = sizeInput.value;
                const color = colorInput.value;

                // 3. Gửi AJAX (Sử dụng Fetch API chuẩn)
                // Lưu ý URL: Kiểm tra Controller là "Home" hay "GioHang" nhé
                const url = '@Url.Action("AddToCart", "Home")'; 

                // Hiển thị loading
                btnAddToCart.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                btnAddToCart.disabled = true;

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        productId: pid,
                        quantity: qty,
                        selectedSize: size,
                        selectedColor: color,
                        // Nếu cần AntiForgeryToken
                        __RequestVerificationToken: document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    success: function(res) {
                        // Khôi phục nút bấm
                        btnAddToCart.innerHTML = '<i class="fa fa-shopping-bag mr-2"></i> Thêm vào giỏ';
                        btnAddToCart.disabled = false;

                        if (res.success) {
                            // Thành công: Hiện thông báo đẹp
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: res.message,
                                showConfirmButton: false,
                                timer: 1500
                            });

                            // Cập nhật số lượng trên icon giỏ hàng (nếu bạn có ID này trên Layout)
                            // Ví dụ: <span id="cart-count">0</span>
                            const cartCountEl = document.getElementById('cart-count'); // Hoặc #cartBadge
                            if (cartCountEl && res.totalItems !== undefined) {
                                cartCountEl.innerText = res.totalItems;
                            }
                        } else {
                            // Thất bại (Logic server trả về false)
                            Swal.fire('Lỗi', res.message, 'error');
                        }
                    },
                    error: function(err) {
                        btnAddToCart.innerHTML = '<i class="fa fa-shopping-bag mr-2"></i> Thêm vào giỏ';
                        btnAddToCart.disabled = false;
                        console.error(err);
                        Swal.fire('Lỗi hệ thống', 'Không thể kết nối đến server.', 'error');
                    }
                });
            });

            // Khởi tạo lần đầu
            updateProductDetails();
        });
    </script>
}