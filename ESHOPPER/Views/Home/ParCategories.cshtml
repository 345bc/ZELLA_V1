@model IEnumerable<ESHOPPER.Models.DanhMucSanPham>

<nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 border border-top-0 border-bottom-0 bg-light" id="navbar-vertical" style="width: calc(100% - 30px); z-index: 1050;">
    <div class="navbar-nav w-100" style="height: 410px; overflow-y: auto;">

        <a href="@Url.Action("Shop", "Home")"
           class="nav-item nav-link @(ViewBag.SelectedCategoryID == null ? "active" : "")">
            Tất cả sản phẩm
        </a>

        @foreach (var parent in Model.Where(dm => dm.MaDanhMucCha == null))
        {
            var subDanhMucs = Model.Where(c => c.MaDanhMucCha == parent.MaDM).ToList();

            // Kiểm tra xem trang hiện tại có thuộc danh mục con của cha này không (để giữ menu mở)
            bool isParentActive = subDanhMucs.Any(x => x.MaDM == (int?)ViewBag.SelectedCategoryID) || parent.MaDM == (int?)ViewBag.SelectedCategoryID;
            string collapseId = "cat-" + parent.MaDM; // Tạo ID duy nhất cho mỗi menu con

            if (subDanhMucs.Any())
            {
                <div class="nav-item">
                    <a href="#@collapseId" data-toggle="collapse" aria-expanded="@(isParentActive ? "true" : "false")" class="nav-link d-flex justify-content-between align-items-center @(isParentActive ? "active" : "")">
                        <span>@parent.TenDanhMuc</span>
                        <i class="fa fa-angle-down"></i>
                    </a>

                    <div class="collapse @(isParentActive ? "show" : "") bg-light border-top" id="@collapseId">
                        @foreach (var child in subDanhMucs)
                        {
                            <a href="@Url.Action("Shop", "Home", new { maDM = child.MaDM })"
                               class="nav-item nav-link pl-4 @(ViewBag.SelectedCategoryID == child.MaDM ? "text-primary font-weight-bold" : "text-secondary")" style="font-size: 0.95em;">
                                <i class="fa fa-angle-right mr-2"></i> @child.TenDanhMuc
                            </a>
                        }
                    </div>
                </div>
            }
            else
            {
                <a href="@Url.Action("Shop", "Home", new { maDM = parent.MaDM })"
                   class="nav-item nav-link @(ViewBag.SelectedCategoryID == parent.MaDM ? "active" : "")">
                    @parent.TenDanhMuc
                </a>
            }
        }
    </div>
</nav>