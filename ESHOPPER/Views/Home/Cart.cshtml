@model IEnumerable<ESHOPPER.Models.ChiTietGioHang>

@{
    ViewBag.Title = "Giỏ hàng của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isLoggedIn = Session["MaKH"] != null;
    decimal cartTotal = 0;
}

<style>
    /* --- STYLE GIỎ HÀNG --- */
    .cart-page {
        padding: 40px 0;
        background: #fff;
    }

    /* Header */
    .cart-header-row {
        font-weight: 600;
        text-transform: uppercase;
        color: #555;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        letter-spacing: 1px;
    }

    /* Item Row */
    .cart-item-row {
        display: flex;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #f5f5f5;
        transition: 0.3s;
    }

        .cart-item-row:hover {
            background-color: #fcfcfc;
        }

    /* Checkbox */
    .cart-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #222;
    }

    /* Ảnh sản phẩm */
    .p-img {
        width: 80px;
        height: 90px;
        object-fit: contain; /* Ảnh luôn vừa, không bị méo */
        border-radius: 4px;
        border: 1px solid #eee;
        background: #fff;
    }

    /* Input số lượng */
    .qty-form {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .qty-input-custom {
        width: 45px;
        height: 35px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-weight: 600;
        outline: none;
        transition: 0.2s;
    }

        .qty-input-custom:focus {
            border-color: #222;
        }

    .btn-update-qty {
        background: none;
        border: none;
        color: #28a745;
        cursor: pointer;
        font-size: 14px;
        padding: 5px;
        display: none; /* Ẩn nút cập nhật, hiện khi cần thiết nếu muốn, hoặc auto submit */
    }

    /* Summary Card (Cột phải) */
    .summary-card {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 8px;
        position: sticky;
        top: 100px;
        border: 1px solid #eee;
    }

    .checkout-btn {
        background: #222;
        color: #fff;
        width: 100%;
        padding: 15px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        border: none;
        letter-spacing: 1px;
        transition: 0.3s;
    }

        .checkout-btn:hover {
            background: #444;
        }
</style>

<div class="container-fluid px-5 cart-page mb-5">
    <div class="row">
        <div class="col-lg-8 mb-5">
            <div class="row cart-header-row d-none d-md-flex align-items-center text-center">
                <div class="col-md-1"><input type="checkbox" id="checkAll" class="cart-checkbox"></div>
                <div class="col-md-5 text-start">SẢN PHẨM</div>
                <div class="col-md-2">ĐƠN GIÁ</div>
                <div class="col-md-2">SỐ LƯỢNG</div>
                <div class="col-md-2 text-end"></div>
            </div>

            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    // Tính thành tiền của từng món
                    decimal lineTotal = (item.DonGia ?? 0) * (item.SoLuong ?? 0);
                    cartTotal += lineTotal;

                    <div class="cart-item-row row text-center" id="row-@item.MaBienThe">
                        <div class="col-md-1">
                            <input type="checkbox" class="cart-checkbox item-check"
                                   value="@item.MaBienThe"
                                   data-total="@lineTotal" />
                        </div>

                        <div class="col-md-5 d-flex align-items-center text-start">
                            <img src="~/Images/Products/@(item.BienTheSanPham?.SanPham?.AnhSP ?? "no-image.png")" class="p-img me-3" />
                            <div>
                                <h6 class="mb-1 text-dark">@(item.BienTheSanPham?.SanPham?.TenSanPham ?? "Sản phẩm")</h6>
                                <small class="text-muted d-block">
                                    Size: @(item.BienTheSanPham?.KichThuoc?.TenSize ?? "-")
                                    | Màu: @(item.BienTheSanPham?.MauSac?.TenMau ?? "-")
                                </small>
                            </div>
                        </div>

                        <div class="col-md-2 fw-bold text-dark">
                            @string.Format("{0:N0} ₫", item.DonGia)
                        </div>

                        <div class="col-md-2">
                            @using (Html.BeginForm("UpdateCart", "Cart", FormMethod.Post, new { @class = "qty-form" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.MaBienThe" />
                                <input type="number" name="quantity" value="@item.SoLuong" min="1" max="99"
                                       class="qty-input-custom" onchange="this.form.submit()" />
                            }
                        </div>

                        <div class="col-md-2 text-end">
                            <a href="@Url.Action("RemoveFromCart", "Home", new { id = item.MaBienThe })"
                               class="text-danger" title="Xóa" onclick="return confirm('Xóa sản phẩm này?')">
                                <i class="fa fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fa fa-shopping-basket fa-3x text-muted mb-3 opacity-25"></i>
                    <h5 class="text-muted">Giỏ hàng của bạn đang trống</h5>
                    <a href="@Url.Action("Shop", "Home")" class="btn btn-dark mt-3 px-4 rounded-pill">Tiếp tục mua sắm</a>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="summary-card shadow-sm">
                <h5 class="fw-bold mb-4 pb-2 border-bottom">ĐƠN HÀNG</h5>

                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Đã chọn:</span>
                    <span class="fw-bold" id="selected-count">0 món</span>
                </div>

                <div class="d-flex justify-content-between mb-4">
                    <span class="text-muted">Tạm tính:</span>
                    <h4 class="fw-bold text-danger" id="cart-total">0 ₫</h4>
                </div>

                <button type="button" id="btnProceedCheckout" class="checkout-btn shadow-sm">
                    THANH TOÁN
                </button>

                <div class="text-center mt-3">
                    <small class="text-muted"><i class="fa fa-lock text-success me-1"></i> Bảo mật thanh toán 100%</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isLoggedIn = @(isLoggedIn ? "true" : "false");

            // Selector chính xác
            const checkboxes = document.querySelectorAll('.item-check'); // Các checkbox sản phẩm
            const checkAll = document.getElementById('checkAll');
            const totalEl = document.getElementById('cart-total');
            const countEl = document.getElementById('selected-count');
            const btnCheckout = document.getElementById('btnProceedCheckout');

            // 1. HÀM TÍNH TỔNG TIỀN (Dựa trên checkbox được chọn)
            function calculateTotal() {
                let total = 0;
                let count = 0;

                checkboxes.forEach(chk => {
                    if (chk.checked) {
                        // Lấy giá trị từ data-total (đã render từ server)
                        total += parseFloat(chk.getAttribute('data-total'));
                        count++;
                    }
                });

                // Format tiền tệ Việt Nam
                totalEl.textContent = total.toLocaleString('vi-VN') + ' ₫';
                countEl.textContent = count + ' món';
            }

            // 2. CHECK ALL
            if (checkAll) {
                checkAll.addEventListener('change', function() {
                    checkboxes.forEach(chk => chk.checked = this.checked);
                    calculateTotal();
                });
            }

            // 3. CHECK TỪNG MÓN
            checkboxes.forEach(chk => {
                chk.addEventListener('change', function() {
                    if (!this.checked && checkAll) checkAll.checked = false;
                    // Nếu tất cả đều được chọn thì check cái CheckAll
                    if (document.querySelectorAll('.item-check:checked').length === checkboxes.length) {
                        if(checkAll) checkAll.checked = true;
                    }
                    calculateTotal();
                });
            });

            // Mặc định chọn tất cả khi vào trang (Tuỳ chọn)
            if(checkAll) {
                checkAll.checked = true;
                checkboxes.forEach(chk => chk.checked = true);
                calculateTotal();
            }

            // 4. XỬ LÝ THANH TOÁN
            btnCheckout.addEventListener('click', function() {
                // Lấy danh sách MaBienThe
                const selectedIds = Array.from(document.querySelectorAll('.item-check:checked'))
                                         .map(cb => cb.value);

                if (selectedIds.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn sản phẩm',
                        text: 'Vui lòng tích chọn ít nhất 1 sản phẩm để thanh toán.',
                        confirmButtonColor: '#222'
                    });
                    return;
                }

                // Chuyển hướng sang trang Checkout với query string
                const idsString = selectedIds.join(',');
                const checkoutUrl = '@Url.Action("Checkout", "Home")'; // Hoặc CartController nếu bạn để ở đó

                // Logic đăng nhập có thể xử lý ở Controller Checkout (Authorize)
                // hoặc xử lý tại đây như code cũ của bạn.
                if (!isLoggedIn) {
                     Swal.fire({
                        title: 'Bạn chưa đăng nhập',
                        text: "Đăng nhập để lưu đơn hàng vào tài khoản của bạn?",
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#222',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Đăng nhập ngay',
                        //cancelButtonText: 'Mua không cần TK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                             // Chuyển đến trang login
                             window.location.href = '@Url.Action("Login", "Auth")?returnUrl=' + encodeURIComponent(window.location.href);
                        } else {
                             // Vẫn cho thanh toán (Guest)
                             window.location.href = checkoutUrl + '?selectedIds=' + idsString;
                        }
                    })
                } else {
                    window.location.href = checkoutUrl + '?selectedIds=' + idsString;
                }
            });
        });
    </script>
}